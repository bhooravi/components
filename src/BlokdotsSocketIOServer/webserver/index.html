<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>blokdots</title>
    <link rel="icon" href="/favicon.ico" />

    <link rel="stylesheet" type="text/css" href="style.css" />

    <script src="socket-io.min.js"></script>
  </head>

  <body>
    <div id="wrapper">
      <h1>blokdots</h1>

      <p>
        This page is generated by the internal blokdots server. You can connect
        to the integrations by connecting with a Socket.IO client to this
        address.
      </p>
      <p>
        For more information, check out the
        <a href="https://blokdots.com/documentation/components/integrations/socket-io-server"
          >blokdots documentation</a
        >.
      </p>

      <br />

      <h1>Connection Status</h1>

      <p>
        Server
        <span id="serverAddress"></span>
        <span id="connectionStatus">not connected</span>
      </p>

      <h1>Active Integrations</h1>
      <div id="activeIntegrations"></div>

      <section id="testMessages">
        <h1>Test Messages</h1>

        <p>
          You can send and receive test messages below. Please make sure that a
          hardware board (like Arduino) is connected and marked as "Ready" in
          blokdots.
        </p>

        <div id="testInput">
          <label
            ><span>Message:</span>
            <input
              type="text"
              id="testMessage"
              name="testMessage"
              placeholder="message"
            />
          </label>
          <label
            ><span>Value:</span>
            <input
              type="text"
              id="testValue"
              name="testValue"
              placeholder="value"
            />
          </label>
          <button>Send</button>
        </div>

        <ul id="socket-history">
          <!-- messages go here -->
        </ul>
      </section>
    </div>

    <script type="text/javascript">
      const generalSocket = io(window.location.origin);

      generalSocket.on("info", (data) => {
        console.log(data);
      });

      const socket = io(window.location.origin + window.location.pathname);
      const integration = window.location.pathname.substring(1);

      let socketContainer = null;

      socket.on("connect", () => {
        document.querySelector("#connectionStatus").textContent =
          "is connected";
        document.querySelector("#connectionStatus").classList.add("ok");
      });

      socket.on("disconnect", () => {
        document.querySelector("#connectionStatus").textContent =
          "not connected";
        document.querySelector("#connectionStatus").classList.remove("ok");
      });

      socket.on("info", (val) => {
        if (val.activeIntegrations) {
          const integrationsHtml = val.activeIntegrations
            .map((integrationName) => {
              return `<span class="code ${
                integrationName === integration ? "ok" : ""
              }">${integrationName}</span>`;
            })
            .join(" ");
          document.querySelector("#activeIntegrations").innerHTML =
            integrationsHtml;
        }
      });

      if (integration === "") {
        document.querySelector("#testMessages").innerHTML =
          "Please open this page with the specific URL for an active integration.";
      }

      if (integration === "blokdots") {
        socket.on("blokdots", (val) => {
          addMessageToList(val);
        });
      }

      if (integration === "protopie") {
        socket.on("ppMessage", (val) => {
          const ppVal = {
            msg: val.messageId,
            val: val.value,
          };
          addMessageToList(ppVal);
        });
      }

      const addMessageToList = (val, dir = "in") => {
        const li = document.createElement("li");

        const timestamp = new Date(Date.now()).toLocaleTimeString();
        const signalDate = document.createElement("span");
        signalDate.classList.add("messageTime");
        signalDate.textContent = timestamp;
        li.appendChild(signalDate);

        const arrowImage = document.createElement("img");
        arrowImage.classList.add("messageArrow");
        arrowImage.src = "log-arrow-" + dir + ".svg";
        li.appendChild(arrowImage);

        const messageDOM = document.createElement("span");
        messageDOM.classList.add("messageContentDisplay");
        messageDOM.textContent = val.msg;
        li.appendChild(messageDOM);

        if (val.val !== undefined && val.val !== null && val.val !== "") {
          const valueDOM = document.createElement("span");
          valueDOM.classList.add("messageValueDisplay");
          if (!isNaN(val.val)) {
            valueDOM.classList.add("messageValueDisplay-is-number");
          }
          valueDOM.textContent = val.val;
          li.appendChild(valueDOM);
        }

        socketContainer.prepend(li);
      };

      const sendMessage = () => {
        const msg = document.querySelector("#testMessage").value;
        let val = document.querySelector("#testValue").value;

        const message = {
          msg,
          val,
        };
        addMessageToList(message, "out");

        if (integration === "blokdots") {
          socket.emit("blokdots", message);
        }
        if (integration === "protopie") {
          socket.emit("ppMessage", { messageId: msg, value: val });
        }
      };

      document.addEventListener("DOMContentLoaded", () => {
        socketContainer = document.querySelector("#socket-history");
        document.querySelector("#serverAddress").textContent =
          window.location.origin + window.location.pathname;

        if (integration !== "") {
          document
            .querySelector("#testInput button")
            .addEventListener("click", sendMessage);
        }
      });
    </script>
  </body>
</html>
